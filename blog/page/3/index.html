
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>My Octopress Blog</title>
  <meta name="author" content="windfire.cd">

  
  <meta name="description" content="来源 本文来源于阅读Understanding the code inside Tornado, the asynchronous web server这篇
文章的简单记录 简介 Tornado是一个python写的异步网络框架。最早是由FriendFeed开发的，后被facebook收购后开源。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://windfire-cd.github.com/blog/page/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="My Octopress Blog" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">My Octopress Blog</a></h1>
  
    <h2>life and I</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:windfire-cd.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/17/tornado-report/">Tornado Report</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-17T17:57:00+08:00" pubdate data-updated="true">Aug 17<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/17/tornado-report/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>来源</h2>

<p>本文来源于阅读<a href="http://golubenco.org/2009/09/19/understanding-the-code-inside-tornado-the-asynchronous-web-server-powering-friendfeed/">Understanding the code inside Tornado, the asynchronous web server</a>这篇
文章的简单记录</p>

<h2>简介</h2>

<p><a href="http://tornadoweb.org/">Tornado</a>是一个python写的异步网络框架。最早是由FriendFeed开发的，后被facebook收购后开源。相比于流行的python
网络开发框架django，它更加简单，灵活，可定制化性强，但是学习曲线陡峭。比较类似的框架是web.py</p>

<h2>异步接口</h2>

<p>对于server端来说，如果考虑是同步的接口类似下面的</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">handler_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">answ</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_server</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="c"># this takes 5 seconds</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">request</span><span class="o">.</span><span class="n">write_response</span><span class="p">(</span><span class="n">answ</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>并发性低，当然可以采用多线程（多进程）处理，但是开销也较大。</p>

<p>但是采用异步接口，类似如下代码</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">handler_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="bp">self</span><span class="o">.</span><span class="n">remote_server</span><span class="o">.</span><span class="n">query_async</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_received</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">response_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">answ</span><span class="p">):</span>    <span class="c"># this is called 5 seconds later</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">request</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">answ</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以参考pythond的异步网络框架twisted</p>

<h2>源码和安装</h2>

<p>可以利用<em>easy_install</em>或者<em>pip</em>进行安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$sudo</span> easy_install tornado
</span></code></pre></td></tr></table></div></figure>


<p>或者下载后安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone http://github.com/facebook/tornado.git
</span><span class='line'><span class="nb">cd </span>tornado
</span><span class='line'>sudo python setup.py install
</span></code></pre></td></tr></table></div></figure>


<p>源码包里有demo的例子</p>

<h2>IOLoop</h2>

<p>这个模块是框架的核心模块： <a href="http://github.com/facebook/tornado/blob/master/tornado/ioloop.py#L17">ioloop.py</a></p>

<p>添加一个socket处理代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Registers the given handler to receive the given events for fd.&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">]</span> <span class="o">=</span> <span class="n">handler</span>
</span><span class='line'>
</span><span class='line'>          <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">events</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>_handlers</strong>是一个字典对象，对应于epoll里面注册的socket列表。</p>

<p><strong>self._impl</strong>或者是<a href="http://docs.python.org/library/select.html#select.epoll">select.epoll()</a>,或者是<a href="http://docs.python.org/library/select.html#select.select">select.select</a></p>

<figure class='code'><figcaption><span>start</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot;Starts the I/O loop.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="sd"> The loop will run until one of the I/O handlers calls stop(), which</span>
</span><span class='line'>
</span><span class='line'><span class="sd"> will make the loop stop after the current event iteration completes.</span>
</span><span class='line'>
</span><span class='line'><span class="sd"> &quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_running</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span> <span class="o">...</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_running</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span> <span class="o">...</span> <span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">event_pairs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_impl</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">poll_timeout</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span> <span class="o">==</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Interrupted system call&quot;</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Interrupted system call&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">continue</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">raise</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Pop one fd at a time from the set of pending fds and run</span>
</span><span class='line'>
</span><span class='line'><span class="c"># its handler. Since that handler may perform actions on</span>
</span><span class='line'>
</span><span class='line'><span class="c"># other file descriptors, there may be reentrant calls to</span>
</span><span class='line'>
</span><span class='line'><span class="c"># this IOLoop that update self._events</span>
</span><span class='line'>
</span><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">event_pairs</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">fd</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_events</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">_handlers</span><span class="p">[</span><span class="n">fd</span><span class="p">](</span><span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">raise</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span> <span class="ne">OSError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPIPE</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Happens when the client closes the connection</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Exception in I/O handler for fd </span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">fd</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Exception in I/O handler for fd </span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">fd</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>关于这个循环的停止，可以通过设置<em>self._running</em>为false来解决，如果停止也是由事件触发的话，那么可以用poll的内部机制来解决，
可以注册一个匿名的管道，当需要退出时，向管道写入某些数据，然后触发停止事件，代码如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">impl</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="c"># Create a pipe that we send bogus data to when we want to wake</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># the I/O loop when it is idle</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_set_nonblocking</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_set_nonblocking</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_waker_reader</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_waker_writer</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_waker</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">WRITE</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">_wake</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="bp">self</span><span class="o">.</span><span class="n">_waker_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">pass</span>
</span></code></pre></td></tr></table></div></figure>


<h2>定时器</h2>

<p>对于IOLoop模块来说实现一个定时器非常简单，利用python的bisect模块实现如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">add_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deadline</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot;Calls the given callback at the time deadline from the I/O loop.&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">timeout</span> <span class="o">=</span> <span class="n">_Timeout</span><span class="p">(</span><span class="n">deadline</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bisect</span><span class="o">.</span><span class="n">insort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeouts</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="n">timeout</span>
</span></code></pre></td></tr></table></div></figure>


<p>在IOLoop模块中epoll比select要快速很多。</p>

<h2>IOStream模块</h2>

<p><a href="http://github.com/facebook/tornado/blob/master/tornado/iostream.py#L25">IOStream</a>提供了非阻塞的socket操作</p>

<ul>
<li><em>read_util</em></li>
<li><em>read_bytes</em></li>
<li><em>write</em></li>
</ul>


<h2>HTTP server</h2>

<p>组合IOLoop模块以及IOStream模块我们可以实现一个异步的<a href="http://github.com/facebook/tornado/blob/master/tornado/httpserver.py#L31">httpserver.py</a></p>

<p>其中<em>HTTPServer</em>类只是接收socket然后将其放入IOLoop中。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">address</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFD</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">flags</span> <span class="o">|=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">FD_CLOEXEC</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFD</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">address</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">128</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_events</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中<em>_handle_events()</em>响应相关事件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="k">def</span> <span class="nf">_handle_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">connection</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span> <span class="n">socket</span><span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">EWOULDBLOCK</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EAGAIN</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">raise</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">try</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'><span class="n">stream</span> <span class="o">=</span> <span class="n">iostream</span><span class="o">.</span><span class="n">IOStream</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span> <span class="n">io_loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">io_loop</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">HTTPConnection</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_callback</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>          <span class="bp">self</span><span class="o">.</span><span class="n">no_keep_alive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xheaders</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">except</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;Error in connection callback&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/15/zookeeper-guide/">Zookeeper Guide</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-15T15:13:00+08:00" pubdate data-updated="true">Aug 15<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/15/zookeeper-guide/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<p>介绍zookeeper的设计以及模型。提供一个简单的例子以及使用方式</p>

<h2>数据模型 data model</h2>

<p>分层的命名空间，每个node都可以有孩子。类似于文件系统中允许节点既可以是文件夹也可以是文件。</p>

<h3>znode</h3>

<p>znode保存一个状态数据结构</p>

<p>具体参见Zookeeper Intro中关于znode的介绍。</p>

<p>对于zookeeper文档中的名称说明</p>

<ul>
<li>znode：表示一个数据节点</li>
<li>servers： 表示组成zookeeper集群的机器</li>
<li>quorum peers：仲裁服务器(啥意思？)</li>
<li>client：表示一个机器或者一个进程使用zookeeper服务</li>
</ul>


<p>对于开发者来说，znode是主要接触的部分。</p>

<p><strong>watches</strong></p>

<p>client可以作为znode的观察者。znode的变换会触发观察者的响应。具体见下面的介绍</p>

<p><strong>Data Access</strong></p>

<p>每个znode上的数据可以被原子读写，具有访问权控制。但是znode主要管理的是协调数据，而不是通用数据
协调数据一般小于1M。如果需要处理大数据，应该用hdfs或者nfs之类的。</p>

<p><strong>Ephemeral Nodes</strong></p>

<p>临时节点，跟session的生存周期相同</p>

<p><strong>Sequence Nodes</strong></p>

<p>顺序节点，根据父节点的序数递增的创建znode。保证命名唯一</p>

<h3>zookeeper的时间</h3>

<p>zookeeper用不同的方式查询时间</p>

<ul>
<li>zxid</li>
<li>version number</li>
<li>ticks</li>
<li>real time 只有在写入状态结构数据的时间戳会用，其他时候不用</li>
</ul>


<h3>状态结构</h3>

<ul>
<li>czxid</li>
<li>mzxid</li>
<li>ctime</li>
<li>mtime</li>
<li>version</li>
<li>cversion</li>
<li>aversion</li>
<li>ephemeralOwner</li>
<li>dataLen</li>
<li>numChildren</li>
</ul>


<h2>会话 sessions</h2>

<p>对于client来说，链接server时创建session，异常或者主动关闭时删除session。下面是状态变换图</p>

<p><img src="http://zookeeper.apache.org/doc/trunk/images/state_dia.jpg"></p>

<p>应用程序需要提供给client一个以逗号分割的字符串，被分割的每个部分子串表示了一个zookeeper的ip和port。
例如</p>

<p> &#8220;127.0.0.1:4545&#8221; or &#8220;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&#8221;</p>

<p>client会挑选一个进行链接，失败的话自动链接下一个。</p>

<blockquote><p>3.2.0版本添加了一个目录chroot，作为链接后的跟目录
例如&#8221;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002/app/a&#8221;</p></blockquote>

<h2>观察者 watcher</h2>

<p>所有的获取数据的操作可以设置一个观察者，比如getData(), getChildren(), exists()
有三个关键点</p>

<ol>
<li>一次性动作。一旦被观察者的数据发生变化，一个watche事件被发送给client，然后变动的数据发送给client，这些在一次动作中完成</li>
<li>发送给client。操作立刻发送给client，但是不保证client收到并重置。发送的动作是异步的，但是server端保证不同的client端收到的
event的顺序是相同的</li>
<li>server端设置的数据。zookeeper需要保存两个watches列表：数据列表和子节点列表。setData触发数据列表变动，create和delete触发两个列表
变动</li>
</ol>


<p>watches列表存储在client链接的server上，便于减轻负担和进行分布式处理。</p>

<p>对于watches来说zookeeper能够保证以下几点</p>

<ul>
<li>wathces是有序的。</li>
<li>client先看到znode的数据变动，然后看到变动的数据</li>
<li>watch事件的顺序和zookeeper service数据发生变动的顺序是相同的</li>
</ul>


<p>对于watches需要注意</p>

<ul>
<li>watch是一次性的动作。</li>
<li>由于网络时延，可能在设置watch的时候，znode数据变动多次。</li>
<li>断开链接后watches不再有作用</li>
</ul>


<h2>访问授权 ACL</h2>

<p>和unix的文件权限类似，但是不仅仅区分user，group，world</p>

<p>ACL permissions</p>

<ul>
<li>CREATE: you can create a child node</li>
<li>READ: you can get data from a node and list its children.</li>
<li>WRITE: you can set data for a node</li>
<li>DELETE: you can delete a child node</li>
<li>ADMIN: you can set permissions</li>
</ul>


<p>Builtin ACL Schemes</p>

<ul>
<li>world</li>
<li>auth</li>
<li>digest</li>
<li>ip</li>
</ul>


<p>下面的简单例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &lt;string.h&gt;</span>
</span><span class='line'><span class="cp">#include &lt;errno.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &quot;zookeeper.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">zhandle_t</span> <span class="o">*</span><span class="n">zh</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * In this example this method gets the cert for your</span>
</span><span class='line'><span class="cm"> *   environment -- you must provide</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">char</span> <span class="o">*</span><span class="nf">foo_get_cert_once</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Watcher function -- empty for this example, not something you should</span>
</span><span class='line'><span class="cm"> * do in real code */</span>
</span><span class='line'><span class="kt">void</span> <span class="nf">watcher</span><span class="p">(</span><span class="n">zhandle_t</span> <span class="o">*</span><span class="n">zzh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
</span><span class='line'>      <span class="kt">void</span> <span class="o">*</span><span class="n">watcherCtx</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">p</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
</span><span class='line'>  <span class="kt">char</span> <span class="o">*</span><span class="n">cert</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">appId</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">strcpy</span><span class="p">(</span><span class="n">appId</span><span class="p">,</span> <span class="s">&quot;example.foo_test&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="n">cert</span> <span class="o">=</span> <span class="n">foo_get_cert_once</span><span class="p">(</span><span class="n">appId</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">cert</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
</span><span class='line'>              <span class="s">&quot;Certificate for appid [%s] is [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">appId</span><span class="p">,</span><span class="n">cert</span><span class="p">);</span>
</span><span class='line'>      <span class="n">strncpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">cert</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>      <span class="n">free</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Certificate for appid [%s] not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">appId</span><span class="p">);</span>
</span><span class='line'>      <span class="n">strcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;dummy&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">zoo_set_debug_level</span><span class="p">(</span><span class="n">ZOO_LOG_LEVEL_DEBUG</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">zh</span> <span class="o">=</span> <span class="n">zookeeper_init</span><span class="p">(</span><span class="s">&quot;localhost:3181&quot;</span><span class="p">,</span> <span class="n">watcher</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">zh</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">errno</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="n">zoo_add_auth</span><span class="p">(</span><span class="n">zh</span><span class="p">,</span><span class="s">&quot;foo&quot;</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">strlen</span><span class="p">(</span><span class="n">p</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">!=</span><span class="n">ZOK</span><span class="p">)</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">struct</span> <span class="n">ACL</span> <span class="n">CREATE_ONLY_ACL</span><span class="p">[]</span> <span class="o">=</span> <span class="p">;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">ACL_vector</span> <span class="n">CREATE_ONLY</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">CREATE_ONLY_ACL</span><span class="p">};</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">zoo_create</span><span class="p">(</span><span class="n">zh</span><span class="p">,</span><span class="s">&quot;/xyz&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">CREATE_ONLY</span><span class="p">,</span> <span class="n">ZOO_EPHEMERAL</span><span class="p">,</span>
</span><span class='line'>          <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** this operation will fail with a ZNOAUTH error */</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">buflen</span><span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">Stat</span> <span class="n">stat</span><span class="p">;</span>
</span><span class='line'>  <span class="n">rc</span> <span class="o">=</span> <span class="n">zoo_get</span><span class="p">(</span><span class="n">zh</span><span class="p">,</span> <span class="s">&quot;/xyz&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;Error %d for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">__LINE__</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">zookeeper_close</span><span class="p">(</span><span class="n">zh</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>一致性保证</h2>

<p>zookeeper性能高，可扩展性强，读写性能高（读比写高）。因为放弃了一部分一致性的要求，client可能在server读取到老的数据。但是可以保证</p>

<ul>
<li>顺序一致性</li>
<li>更新原子性</li>
<li>单一系统视图</li>
<li>可靠性：monotonicity condition in Paxos; 不会因为恢复server而回滚数据</li>
<li>及时性：保证一定时间内client获取到最新数据。</li>
</ul>


<p>利用上述特性可以容易的利用zookeeper接口完成leader election, barriers, queues, and read/write revocable locks 操作</p>

<p>zookeeper不保证下面的特性</p>

<ul>
<li>Simultaneously Consistent Cross-Client Views</li>
</ul>


<h2>语言绑定</h2>

<p>可以绑定java和c</p>

<h2>简单操作</h2>

<h3>处理错误</h3>

<p>java和c都返回错误</p>

<p><em>java</em></p>

<p><em>throwing KeeperException, calling code() on the exception will return the specific error code</em></p>

<p><em>c</em></p>

<p><em>returns an error code as defined in the enum ZOO_ERRORS</em></p>

<h3>链接zookeeper</h3>

<h3>读操作</h3>

<h3>写操作</h3>

<h3>处理观察事件</h3>

<h3>zookeeper处理</h3>

<h3>java例子</h3>

<figure class='code'><figcaption><span>Executor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A simple example program to use DataMonitor to start and</span>
</span><span class='line'><span class="cm"> * stop executables based on a znode. The program watches the</span>
</span><span class='line'><span class="cm"> * specified znode and saves the data that corresponds to the</span>
</span><span class='line'><span class="cm"> * znode in the filesystem. It also starts the specified program</span>
</span><span class='line'><span class="cm"> * with the specified arguments when the znode exists and kills</span>
</span><span class='line'><span class="cm"> * the program if the znode goes away.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.KeeperException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.WatchedEvent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.Watcher</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.ZooKeeper</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Executor</span>
</span><span class='line'><span class="kd">implements</span> <span class="n">Watcher</span><span class="o">,</span> <span class="n">Runnable</span><span class="o">,</span> <span class="n">DataMonitor</span><span class="o">.</span><span class="na">DataMonitorListener</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="n">String</span> <span class="n">znode</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">DataMonitor</span> <span class="n">dm</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ZooKeeper</span> <span class="n">zk</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">String</span> <span class="n">filename</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">String</span> <span class="n">exec</span><span class="o">[];</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Process</span> <span class="n">child</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">Executor</span><span class="o">(</span><span class="n">String</span> <span class="n">hostPort</span><span class="o">,</span> <span class="n">String</span> <span class="n">znode</span><span class="o">,</span> <span class="n">String</span> <span class="n">filename</span><span class="o">,</span>
</span><span class='line'>          <span class="n">String</span> <span class="n">exec</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">KeeperException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">exec</span> <span class="o">=</span> <span class="n">exec</span><span class="o">;</span>
</span><span class='line'>      <span class="n">zk</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ZooKeeper</span><span class="o">(</span><span class="n">hostPort</span><span class="o">,</span> <span class="mi">3000</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span><span class='line'>      <span class="n">dm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataMonitor</span><span class="o">(</span><span class="n">zk</span><span class="o">,</span> <span class="n">znode</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="k">this</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * @param args</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">err</span>
</span><span class='line'>              <span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;USAGE: Executor hostPort znode filename program [args ...]&quot;</span><span class="o">);</span>
</span><span class='line'>          <span class="n">System</span><span class="o">.</span><span class="na">exit</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">hostPort</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">];</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">znode</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">1</span><span class="o">];</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">exec</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">args</span><span class="o">.</span><span class="na">length</span> <span class="o">-</span> <span class="mi">3</span><span class="o">];</span>
</span><span class='line'>      <span class="n">System</span><span class="o">.</span><span class="na">arraycopy</span><span class="o">(</span><span class="n">args</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">exec</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">exec</span><span class="o">.</span><span class="na">length</span><span class="o">);</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">new</span> <span class="nf">Executor</span><span class="o">(</span><span class="n">hostPort</span><span class="o">,</span> <span class="n">znode</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">exec</span><span class="o">).</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  * We do process any events ourselves, we just need to forward them on.</span>
</span><span class='line'><span class="cm">  *</span>
</span><span class='line'><span class="cm">  * @see org.apache.zookeeper.Watcher#process(org.apache.zookeeper.proto.WatcherEvent)</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">dm</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>          <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">while</span> <span class="o">(!</span><span class="n">dm</span><span class="o">.</span><span class="na">dead</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">wait</span><span class="o">();</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">closing</span><span class="o">(</span><span class="kt">int</span> <span class="n">rc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">notifyAll</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">static</span> <span class="kd">class</span> <span class="nc">StreamWriter</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">OutputStream</span> <span class="n">os</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">InputStream</span> <span class="n">is</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">StreamWriter</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">os</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">this</span><span class="o">.</span><span class="na">is</span> <span class="o">=</span> <span class="n">is</span><span class="o">;</span>
</span><span class='line'>          <span class="k">this</span><span class="o">.</span><span class="na">os</span> <span class="o">=</span> <span class="n">os</span><span class="o">;</span>
</span><span class='line'>          <span class="n">start</span><span class="o">();</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>          <span class="kt">byte</span> <span class="n">b</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">80</span><span class="o">];</span>
</span><span class='line'>          <span class="kt">int</span> <span class="n">rc</span><span class="o">;</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">while</span> <span class="o">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">b</span><span class="o">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">os</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">rc</span><span class="o">);</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">exists</span><span class="o">(</span><span class="kt">byte</span><span class="o">[]</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Killing process&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">child</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
</span><span class='line'>              <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">child</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
</span><span class='line'>              <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          <span class="n">child</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">child</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Stopping child&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">child</span><span class="o">.</span><span class="na">destroy</span><span class="o">();</span>
</span><span class='line'>              <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">child</span><span class="o">.</span><span class="na">waitFor</span><span class="o">();</span>
</span><span class='line'>              <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                  <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>              <span class="o">}</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">FileOutputStream</span> <span class="n">fos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileOutputStream</span><span class="o">(</span><span class="n">filename</span><span class="o">);</span>
</span><span class='line'>              <span class="n">fos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
</span><span class='line'>              <span class="n">fos</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Starting child&quot;</span><span class="o">);</span>
</span><span class='line'>              <span class="n">child</span> <span class="o">=</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">exec</span><span class="o">);</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">StreamWriter</span><span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">(),</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">);</span>
</span><span class='line'>              <span class="k">new</span> <span class="nf">StreamWriter</span><span class="o">(</span><span class="n">child</span><span class="o">.</span><span class="na">getErrorStream</span><span class="o">(),</span> <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>DataMonitor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * A simple class that monitors the data and existence of a ZooKeeper</span>
</span><span class='line'><span class="cm"> * node. It uses asynchronous ZooKeeper APIs.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.KeeperException</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.WatchedEvent</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.Watcher</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.ZooKeeper</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.AsyncCallback.StatCallback</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.KeeperException.Code</span><span class="o">;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">org.apache.zookeeper.data.Stat</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DataMonitor</span> <span class="kd">implements</span> <span class="n">Watcher</span><span class="o">,</span> <span class="n">StatCallback</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ZooKeeper</span> <span class="n">zk</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">String</span> <span class="n">znode</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Watcher</span> <span class="n">chainedWatcher</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">boolean</span> <span class="n">dead</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">DataMonitorListener</span> <span class="n">listener</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">byte</span> <span class="n">prevData</span><span class="o">[];</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="nf">DataMonitor</span><span class="o">(</span><span class="n">ZooKeeper</span> <span class="n">zk</span><span class="o">,</span> <span class="n">String</span> <span class="n">znode</span><span class="o">,</span> <span class="n">Watcher</span> <span class="n">chainedWatcher</span><span class="o">,</span>
</span><span class='line'>          <span class="n">DataMonitorListener</span> <span class="n">listener</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">zk</span> <span class="o">=</span> <span class="n">zk</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">znode</span> <span class="o">=</span> <span class="n">znode</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">chainedWatcher</span> <span class="o">=</span> <span class="n">chainedWatcher</span><span class="o">;</span>
</span><span class='line'>      <span class="k">this</span><span class="o">.</span><span class="na">listener</span> <span class="o">=</span> <span class="n">listener</span><span class="o">;</span>
</span><span class='line'>      <span class="c1">// Get things started by checking if the node exists. We are going</span>
</span><span class='line'>      <span class="c1">// to be completely event driven</span>
</span><span class='line'>      <span class="n">zk</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">znode</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">  * Other classes use the DataMonitor by implementing this method</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'>  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">DataMonitorListener</span> <span class="o">{</span>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">      * The existence status of the node has changed.</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="kt">void</span> <span class="nf">exists</span><span class="o">(</span><span class="kt">byte</span> <span class="n">data</span><span class="o">[]);</span>
</span><span class='line'>
</span><span class='line'>      <span class="cm">/**</span>
</span><span class='line'><span class="cm">      * The ZooKeeper session is no longer valid.</span>
</span><span class='line'><span class="cm">      *</span>
</span><span class='line'><span class="cm">      * @param rc</span>
</span><span class='line'><span class="cm">      *                the ZooKeeper reason code</span>
</span><span class='line'><span class="cm">      */</span>
</span><span class='line'>      <span class="kt">void</span> <span class="nf">closing</span><span class="o">(</span><span class="kt">int</span> <span class="n">rc</span><span class="o">);</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">(</span><span class="n">WatchedEvent</span> <span class="n">event</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">String</span> <span class="n">path</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">getPath</span><span class="o">();</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getType</span><span class="o">()</span> <span class="o">==</span> <span class="n">Event</span><span class="o">.</span><span class="na">EventType</span><span class="o">.</span><span class="na">None</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="c1">// We are are being told that the state of the</span>
</span><span class='line'>          <span class="c1">// connection has changed</span>
</span><span class='line'>          <span class="k">switch</span> <span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">getState</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">case</span> <span class="nl">SyncConnected:</span>
</span><span class='line'>                  <span class="c1">// In this particular example we don&#39;t need to do anything</span>
</span><span class='line'>                  <span class="c1">// here - watches are automatically re-registered with </span>
</span><span class='line'>                  <span class="c1">// server and any watches triggered while the client was </span>
</span><span class='line'>                  <span class="c1">// disconnected will be delivered (in order of course)</span>
</span><span class='line'>                  <span class="k">break</span><span class="o">;</span>
</span><span class='line'>              <span class="k">case</span> <span class="nl">Expired:</span>
</span><span class='line'>                  <span class="c1">// It&#39;s all over</span>
</span><span class='line'>                  <span class="n">dead</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>                  <span class="n">listener</span><span class="o">.</span><span class="na">closing</span><span class="o">(</span><span class="n">KeeperException</span><span class="o">.</span><span class="na">Code</span><span class="o">.</span><span class="na">SessionExpired</span><span class="o">);</span>
</span><span class='line'>                  <span class="k">break</span><span class="o">;</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">path</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">path</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">znode</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// Something has changed on the node, let&#39;s find out</span>
</span><span class='line'>              <span class="n">zk</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">znode</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">chainedWatcher</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">chainedWatcher</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">event</span><span class="o">);</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">processResult</span><span class="o">(</span><span class="kt">int</span> <span class="n">rc</span><span class="o">,</span> <span class="n">String</span> <span class="n">path</span><span class="o">,</span> <span class="n">Object</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">Stat</span> <span class="n">stat</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="kt">boolean</span> <span class="n">exists</span><span class="o">;</span>
</span><span class='line'>      <span class="k">switch</span> <span class="o">(</span><span class="n">rc</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="n">Code</span><span class="o">.</span><span class="na">Ok</span><span class="o">:</span>
</span><span class='line'>              <span class="n">exists</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>              <span class="k">break</span><span class="o">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="n">Code</span><span class="o">.</span><span class="na">NoNode</span><span class="o">:</span>
</span><span class='line'>              <span class="n">exists</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>              <span class="k">break</span><span class="o">;</span>
</span><span class='line'>          <span class="k">case</span> <span class="n">Code</span><span class="o">.</span><span class="na">SessionExpired</span><span class="o">:</span>
</span><span class='line'>          <span class="k">case</span> <span class="n">Code</span><span class="o">.</span><span class="na">NoAuth</span><span class="o">:</span>
</span><span class='line'>              <span class="n">dead</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>              <span class="n">listener</span><span class="o">.</span><span class="na">closing</span><span class="o">(</span><span class="n">rc</span><span class="o">);</span>
</span><span class='line'>              <span class="k">return</span><span class="o">;</span>
</span><span class='line'>          <span class="k">default</span><span class="o">:</span>
</span><span class='line'>              <span class="c1">// Retry errors</span>
</span><span class='line'>              <span class="n">zk</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">znode</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="k">this</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>              <span class="k">return</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">byte</span> <span class="n">b</span><span class="o">[]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">(</span><span class="n">exists</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>              <span class="n">b</span> <span class="o">=</span> <span class="n">zk</span><span class="o">.</span><span class="na">getData</span><span class="o">(</span><span class="n">znode</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">KeeperException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="c1">// We don&#39;t need to worry about recovering now. The watch</span>
</span><span class='line'>              <span class="c1">// callbacks will kick off any exception handling</span>
</span><span class='line'>              <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
</span><span class='line'>          <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>              <span class="k">return</span><span class="o">;</span>
</span><span class='line'>          <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">((</span><span class="n">b</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">b</span> <span class="o">!=</span> <span class="n">prevData</span><span class="o">)</span>
</span><span class='line'>              <span class="o">||</span> <span class="o">(</span><span class="n">b</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">Arrays</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">prevData</span><span class="o">,</span> <span class="n">b</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'>          <span class="n">listener</span><span class="o">.</span><span class="na">exists</span><span class="o">(</span><span class="n">b</span><span class="o">);</span>
</span><span class='line'>          <span class="n">prevData</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/15/zookeeper-intro/">Zookeeper Intro</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-15T10:48:00+08:00" pubdate data-updated="true">Aug 15<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/15/zookeeper-intro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<p><a href="http://zookeeper.apache.org/">Zookeeper</a>是一个开源的分布式的协调服务框架，主要为分布式应用程序提供服务。它提供一些列简单的原语进行同步，配置维护，全局命名
等服务。它是java语言实现的，但是可以绑定运行java以及c的程序</p>

<p>它的主要作用是提供协调服务，减轻分布式应用程序的协调负担。</p>

<h2>目标</h2>

<h3>简单</h3>

<p>对于zookeeper来说，每个分布式节点类似于一个文件系统的文件。它为其提供分层命名空间下的协调通信服务。zookeeper将数据保存在内存中
而不是硬盘中，所以时延较低</p>

<h3>分布式</h3>

<p>zookeeper本身就是分布式的</p>

<p><img src="http://zookeeper.apache.org/doc/trunk/images/zkservice.jpg"></p>

<p>运行在不同机器上的zookeeper服务可以彼此通信。如果大部分的服务器运转正常，则zookeeper依然可用。</p>

<blockquote><p>即少部分的机器异常不影响整体服务
每个client都和一个server保持tcp链接
client通过这个链接传递请求和响应以及心跳，一旦server异常，client可以立刻链接别的server</p></blockquote>

<h3>有序</h3>

<p>zookeeper对每次更新提供一个全局序数，随后的操作可以利用该序数进行高层一致性抽象操作，比如同步</p>

<blockquote><p>zookeeper提供全局锁，类似google  chuddy？</p></blockquote>

<h3>快速</h3>

<p>zookeeper是一个读取操作比写入操作要快的服务，在上千个服务器上运行zookeeper的话，一般来说，读写速度是10：1</p>

<blockquote><p>考虑到分布式的特性，读可以进行分离，但是写的话需要锁以及一致性操作</p></blockquote>

<h2>架构</h2>

<p><img src="http://zookeeper.apache.org/doc/trunk/images/zknamespace.jpg"></p>

<p>zookeeper的提供一个分层的命名空间。每个节点都可以有孩子节点，类似于文件系统中每个文件也可以作为文件夹。节点被称为znode</p>

<p>znode保存一个包含数据修改版本，ACL修改记录，以及时间戳的状态结构。允许缓存验证和协调更新。每次状态结构修改，则版本自增1.</p>

<p>znode上的数据读取和写入提供原子操作。zookeeper可以允许存在临时节点，节点生存周期和session相同。</p>

<p>zookeeper提供观察功能，client可以作为znode的观察者，一旦znode数据发生变换，那么client会被通知。</p>

<h2>一致性</h2>

<ul>
<li>顺序一致性：client的更新会被按照发送顺序操作</li>
<li>原子性：更新或者成功或者失败，不会出现其他结果</li>
<li>单一的系统链接表示：所有client观察到的系统都是</li>
<li>可靠性：一旦更新提交了，在下一个更新来之前都是有效的</li>
<li>时效性：对于client来说，看到的都是最新的数据</li>
</ul>


<h2>API</h2>

<ul>
<li>create</li>
<li>delete</li>
<li>exists</li>
<li>get data</li>
<li>set data</li>
<li>get chirldren</li>
<li>sync</li>
</ul>


<h2>实现</h2>

<p>下面是zookeeper的结构图</p>

<p><img src="http://zookeeper.apache.org/doc/trunk/images/zkcomponents.jpg"></p>

<p>在zookeeper服务中，每个zookeeper的节点都有上述几个模块</p>

<p>replicated database是一个内存数据库，保存修改日志到硬盘上。</p>

<p>每个client端，连接一个指定的server提交相关的request。可以从当前server中读取相关信息。</p>

<p>作为协议公认的方式，所有的信息写入都发给一个当前系统固定的server，被称为leader.其他的server被称为follower.其中follower从leader获取
相关消息。zookeeper的消息层负责leader失效的重新选举和follower同步。</p>

<h2>使用及性能</h2>

<p>使用zookeeper提供的高层api，可以完成分布式系统中的同步原语，分组以及所有权管理。
其性能测试如下</p>

<p><img src="http://zookeeper.apache.org/doc/trunk/images/zkperfRW-3.2.jpg"></p>

<p><a href="http://zookeeper.apache.org/doc/trunk/zookeeperOver.html">Overview</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/13/twitter-storm/">Twitter Storm</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-13T10:20:00+08:00" pubdate data-updated="true">Aug 13<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/13/twitter-storm/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<p>Twitter Storm是Twitter开源的一个实时流数据处理框架，主要基于Java，部分可用
python。原来是BackType开发的，后被Twitter收购，整理后开源。主要用于下面三个领域</p>

<ol>
<li>信息流处理(stream processing): 处理实时数据和更新数据库</li>
<li>连续计算(continuous computation): 可以连续查询并反馈给用户</li>
<li>分布式远程过程调用(distributed rpc): 处理密集数据。</li>
</ol>


<p>特点如下</p>

<ol>
<li>编程模型类似mapreduce，简化复杂性</li>
<li>使用各种语言，默认支持clojure, java, ruby, python。支持其他语言需要实现storm的通信协议</li>
<li>容错性。管理工作进程和节点的故障</li>
<li>水平扩展。计算在多线程，进程和服务器间进行</li>
<li>可靠消息处理。storm保证每个消息至少被完整处理一次</li>
<li>快速。 使用zeromq为底层消息队列</li>
<li>本地模式。用于快速开发和调试</li>
</ol>


<h2>storm-start</h2>

<h3>编译及安装</h3>

<p><strong>jdk</strong></p>

<p>首先需要安装jdk支持否则会提示缺少<em>tools.jar</em>，需要注意的是要安装jdk6，jdk7编译
会有问题。具体步骤见<a href="http://www.devsniper.com/ubuntu-12-04-install-sun-jdk-6-7/">install jdk on ubuntu</a></p>

<p><em>注意如果先安装jdk，然后安装maven2的话，需要重新设置下jdk版本，具体见上面的安装</em></p>

<p><strong>twitter4j</strong></p>

<p>然后去下载<a href="https://github.com/twitter/twitter4j.git">twitter4j</a>，否则安装时会
提示缺少这个库支持，而且也下载不来，应该是被墙了。</p>

<p>在编译twitter4j时，利用其文件夹内的package.sh文件。只有twitter-core编译成功
其他的没有库支持，而且也下不来，需要首先安装twitter-core</p>

<p>下载最新的jdk6进行编译的话，缺少json包支持，需要在twitter4j-core文件夹中的
pom.xml中添加json包依赖见<a href="http://mvnrepository.com/artifact/org.json/json/20090211">maven2 json</a></p>

<p>需要忽略test进行编译打包，首先完成core的编译，然后安装</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$cd</span>  twitter4j-core
</span><span class='line'><span class="nv">$mvn</span> compile
</span><span class='line'><span class="nv">$mvn</span> package -Dmaven.test.skip<span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="nv">$mvn</span> install:install-file -DgroupId<span class="o">=</span>org.twitter4j -DartifactId<span class="o">=</span>twitter4j-core -Dversion<span class="o">=</span>2.2.6-SNAPSHOT -Dpackaging<span class="o">=</span>jar -Dfile<span class="o">=</span>target/twitter4j-core-2.2.6-SNAPSHOT.jar
</span><span class='line'><span class="nv">$cd</span> ..
</span></code></pre></td></tr></table></div></figure>


<p>然后编译安装twitter-async</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$cd</span> twitter4j-async
</span><span class='line'><span class="nv">$mvn</span> compile
</span><span class='line'><span class="nv">$mvn</span> package -Dmaven.test.skip<span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="nv">$mvn</span> install:install-file -DgroupId<span class="o">=</span>org.twitter4j -DartifactId<span class="o">=</span>twitter4j-async -Dversion<span class="o">=</span>2.2.6-SNAPSHOT -Dpackaging<span class="o">=</span>jar -Dfile<span class="o">=</span>target/twitter4j-async-2.2.6-SNAPSHOT.jar
</span><span class='line'><span class="nv">$cd</span> ..
</span></code></pre></td></tr></table></div></figure>


<p>最后编译安装twitter-stream</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$cd</span> twitter4j-stream
</span><span class='line'><span class="nv">$mvn</span> compile
</span><span class='line'><span class="nv">$mvn</span> package -Dmaven.test.skip<span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="nv">$mvn</span> install:install-file -DgroupId<span class="o">=</span>org.twitter4j -DartifactId<span class="o">=</span>twitter4j-stream -Dversion<span class="o">=</span>2.2.6-SNAPSHOT -Dpackaging<span class="o">=</span>jar -Dfile<span class="o">=</span>target/twitter4j-stream-2.2.6-SNAPSHOT.jar
</span><span class='line'><span class="nv">$cd</span> ..
</span></code></pre></td></tr></table></div></figure>


<p><strong>storm-start</strong></p>

<p>利用maven进行编译测试</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn -f m2-pom.xml compile <span class="nb">exec</span>:java -Dexec.classpathScope<span class="o">=</span>compile -Dexec.mainClass<span class="o">=</span>storm.starter.WordCountTopology
</span></code></pre></td></tr></table></div></figure>


<p>打包</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>mvn -f m2-pom.xml package
</span></code></pre></td></tr></table></div></figure>


<p>注：如果需要在单机模式下运行打包内的文件，需要首先安装storm的release版本
然后运行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>storm jar target/storm-starter-0.0.1-SNAPSHOT-jar-with-dependencies.jar storm.starter.WordCountTopology
</span></code></pre></td></tr></table></div></figure>


<h2>安装storm</h2>

<h3>依赖</h3>

<p><strong>build-essential</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get install build-essential
</span></code></pre></td></tr></table></div></figure>


<p><strong>zookeeper</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> wget http://ftp.meisei-u.ac.jp/mirror/apache/dist//zookeeper/zookeeper-3.3.3/zookeeper-3.3.3.tar.gz
</span><span class='line'> tar zxf zookeeper-3.3.3.tar.gz
</span><span class='line'> cp -R zookeeper-3.3.3 /usr/local/
</span><span class='line'> ln -s /usr/local/zookeeper-3.3.3/ /usr/local/zookeeper
</span><span class='line'> vi ~./bashrc <span class="o">(</span>设置ZOOKEEPER_HOME和ZOOKEEPER_HOME/bin<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>编辑/etc/enviroment,添加</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">ZOOKEEPER_HOME</span><span class="o">=</span>/usr/loacl/zookeeper
</span><span class='line'><span class="nv">PATH</span><span class="o">=</span><span class="s2">&quot;$PATH:$ZOOKEEPER_HOME/bin&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>设置配置文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> cp /usr/local/zookeeper/conf/zoo_sample.cfg /usr/local/zookeeper/conf/zoo.cfg <span class="o">(</span>用zoo_sample.cfg制作<span class="nv">$ZOOKEEPER_HOME</span>/conf/zoo.cfg<span class="o">)</span>
</span><span class='line'> sudo mkdir /tmp/zookeeper
</span><span class='line'> sudo mkdir /var/log/zookeeper
</span></code></pre></td></tr></table></div></figure>


<p>好的，zookeeper的单机安装已经完成了。</p>

<p><strong>zeromq</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> wget http://download.zeromq.org/historic/zeromq-2.1.7.tar.gz
</span><span class='line'> tar zxf zeromq-2.1.7.tar.gz
</span><span class='line'> <span class="nb">cd </span>zeromq-2.1.7
</span><span class='line'> ./configure
</span><span class='line'> make
</span><span class='line'> make install
</span><span class='line'> sudo ldconfig <span class="o">(</span>更新LD_LIBRARY_PATH<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>./configure时会遇到uuid</p>

<p><strong>jzmq</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> <span class="nb">cd </span>jzmq
</span><span class='line'> ./autogen.sh
</span><span class='line'> ./configure
</span><span class='line'> touch src/classdist_noinst.stamp
</span><span class='line'> <span class="nb">cd </span>src/org/zeromq/
</span><span class='line'> javac *.java
</span><span class='line'> <span class="nb">cd</span> ../../../
</span><span class='line'> make
</span><span class='line'> sudo make install
</span></code></pre></td></tr></table></div></figure>


<p>需要安装pkg-config, libtool, automake</p>

<p>需要创建<em>classdist_noinst.stamp</em>后编译java文件否则会报错</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="sb">`</span>classdist_noinst.stamp<span class="s1">&#39;, needed by `org/zeromq/ZMQ.class&#39;</span>.  Stop
</span></code></pre></td></tr></table></div></figure>


<p>完成后设置PATH</p>

<h2>参考</h2>

<p><a href="http://hitina.lofter.com/post/a8c5e_12e927/">Twitter Storm：What &amp; Why？</a></p>

<p><a href="http://www.open-open.com/lib/view/open1328286398374.html">Twitter Storm 实时数据处理框架分析总结</a></p>

<p><a href="http://chenlx.blog.51cto.com/4096635/748737">Twitter Storm 在生产集群运行拓扑</a></p>

<p><a href="http://blog.csdn.net/azhao_dn/article/category/937267">Twitter Storm blog 参考</a></p>

<p><a href="http://blog.csdn.net/larrylgq/article/details/7326058">blog one</a></p>

<p><a href="http://blog.csdn.net/larrylgq/article/details/7326058">tter storm 配置项 </a></p>

<p><a href="https://github.com/nathanmarz/storm-starter">storm-starter</a></p>

<p><a href="https://github.com/nathanmarz/storm/">storm</a></p>

<p><a href="http://hitina.lofter.com/post/a8c5e_136579/">Twitter Storm 安装实战</a></p>

<p><a href="http://my.oschina.net/mingdongcheng/blog/43009">安装twitter storm集群组件ZeroMQ，jzmq时遇到的一系列问题</a></p>

<p><a href="http://www.cnblogs.com/panfeng412/">taobaoer blog</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/09/apache-kafka-jie-shao/">Apache Kafka 介绍</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T18:20:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/09/apache-kafka-jie-shao/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>来源</h2>

<p>此项目最开始由Linkedln开发并开源的一个消息系统。Linkdeln将其作为
可读写的流以及服务状态的数据管道。对于一个网站来说，读写流
经常用来记录页面浏览信息，展示信息以及搜素信息，这些信息一般由日志
系统进行记录。服务状态包括当前机器的cpu, IO, 请求时间， 服务日志等。
近年来，服务状态日益成为衡量网站质量的标志。</p>

<h2>使用读写流以及服务状态的例子</h2>

<ul>
<li>消息广播(News feed) 朋友活动的广播</li>
<li>用户评分以及相关性计算</li>
<li>安全：需要可以进行监测恶意攻击，平衡集群负载等操作</li>
<li>监控</li>
<li>报表以及离线数据处理：hadoop</li>
</ul>


<h2>活跃数据特性</h2>

<p>大流量的数据活跃无法确定大小。传统的日志方式是一种离线的处理方式
比如离线的报告和压缩。对于实时系统，这种方式时延就泰高了。现有的消息队列系统
处理周期。kafka作为一个队列系统可以分别处理离线以及实时的问题。</p>

<h2>linkdedln的模块结构</h2>

<p><img src="http://incubator.apache.org/kafka/images/tracking_high_level.png"></p>

<p>一个kafka的队列系统可以对应于多个模块的数据处理。还可以利用其进行不同数据中心的
数据备份。</p>

<p>kafka集群并不是在数据中心中集中进行部署并提供服务，而是根据数据流拓扑部署多个
集群，不同集群间通过同步来进行数据流处理，其中镜像集群只是源集群的一个消费者。
下面的图示表示了这个过程</p>

<p><img src="http://incubator.apache.org/kafka/images/kafka_multidc.png"></p>

<h2>kafka设计</h2>

<ul>
<li>kafka为一般情况下的持久化消息队列系统</li>
<li>设计约束主要考量吞吐量而不是功能</li>
<li>消息处理模块记录所处理消息的状态，而不是消息提供模块</li>
<li>kafka被设计为分布式部署，其中消息的生产者，代理者和消费者可以分布于整个集群</li>
</ul>


<h3>基础</h3>

<p>消息是模块间通信的基础单元，消息被发布到代理不同主题的服务器上，某些消费模块
订阅该主题，那么所有被发布的消息都被订阅该主题的消费者收到。</p>

<p>kafka的分布式方案对于生产者和代理者来说比较明晰，但是对于消费者，需要一个特别的
设置和支持。消费者组的概念可以类似于JMS中的队列以及主题，这里的消费者组
可以作为一个逻辑上的单一消费者出现在集群中。对于队列，可以把所有的消费者
作为一个组，而将不同的消费者组成不同的组则对应了主题。一般的情况是根据
不同的主题分为不同的逻辑组，逻辑组作为一个单独的对象出现在集群中。kafka的一个
额外特性是在大量的数据下，不论一个主题内有多少消费者，一个消息只存储一次。</p>

<h3>消息持久化和缓存</h3>

<p>Kafka的持久化和缓存依赖于文件系统。对于硬盘来说，顺序读写的性能是随机读写性能
的10000倍，某些情况下顺序访问硬盘比随机访问内存要快。</p>

<p>现代操作系统都会为硬盘申请内存作为缓存。操作系统会倾向于将所有空闲的内存
分配给硬盘作为缓存，虽然这样会造成内存重新申请的性能损失。硬盘通过该缓冲区进行
读写，这个特性除非用直接的I/O操作，否则不会轻易被关闭。所以，即使一个进程缓存了
所有的数据，该数据也可能被复制进系统页缓存中，这样造成所有的东西被存储了2次</p>

<p>另外，基于JVM的应用对于内存的使用存在两个问题</p>

<ol>
<li>对象使用内存很高基本两倍于对象存储的内存</li>
<li>在堆内数据增长的时候，垃圾回收机制比较简单和消耗性能</li>
</ol>


<p>由于上面两点，利用文件系统缓存机制要优于直接利用内存缓存或类似机制。因此
kafka至少保持可用内存的两倍大小的缓存，如果需要存储压缩数据，则变成4倍大小
因此，对于一个32GB内存的机器，kafka会保持28-30GB的缓存，而不需要担心GC影响。
另外，一旦服务重启，这个缓存可以快速的重新载入，而进程内缓存需要在内存中重新申请
或者由代码进行初始化。所以这种机制简化了代码逻辑，对于内存和文件系统的同步
由操作系统完成。</p>

<p>基于以上，这种设计非常简单：不是在内存中保存数据，然后需要的时候flush进硬盘
，而是反过来，首先将所有数据写入文件系统的一个持久化日志中而不是由进程调用
flush数据操作。这意味着只要将数据写入内核页缓存中，然后给系统一个配置，多长
时间或者多大数据后将数据flush进硬盘中即可。</p>

<h3>恒定的时间消耗</h3>

<p>一般来说消息系统的元数据都是BTree存储的，虽然其可操作性强，时间开销是O(logN).
但是结合硬盘操作后，随机查找增多造成性能损耗严重。而日志系统的读取是顺序，
写入是直接在文件后进行添加，虽然比BTree没有更好的操作性，但是时间开销是O(1)
的，而且读取不会锁住写入操作或者彼此加锁。这样设计的一个显著优势是不再受数据大小的限制。
这样可以保存数据很长的时间，而不是一旦消息被分发就会被删除。</p>

<h3>效率优化手段</h3>

<p>假设消息量较大，但是对于每个发布的消息而言，消费的次数要大于生成的次数，因此
优化的手段在消费者更加有效。</p>

<p>两个影响性能的部分为</p>

<ul>
<li>大量的网络请求</li>
<li>多余的数据拷贝</li>
</ul>


<p>对于网络请求，根据消息特性进行分组，可以将同组消息打包为&#8221;message set&#8221;，每次
可以将多个消息打包后发送，而不是单独发送每个消息。对于MessageSet，接口简单
一般不需要进行序列化和反序列化</p>

<p>消息日志被broker保存其硬盘上。因此，即使单个字节的消息也可以被不同的brokeer和
consumer共享。</p>

<p>现代unix系统可以支持代码直接将页面缓存的数据直接发送给网络缓存，减少中间拷贝
次数。Linux中利用sendfile系统调用完成这个功能，Java提供了标准库调用FileChannel.transferTo
接口</p>

<p>一般来说对于通过socket发送系统中的数据需要通过以下几个步骤</p>

<ol>
<li>内核空间上，硬盘读取到页面缓存</li>
<li>用户空间读取内核空间的数据</li>
<li>在将数据从用户空间写入到内核空间的socket缓存</li>
<li>系统将socket缓存中的数据拷贝到NIC缓存中</li>
</ol>


<p>需要4此拷贝，2次系统调用。利用sendfile，可以直接将页面缓存拷贝到网络中，
因此只有第4步拷贝到NIC缓存中</p>

<p>对于同个主题的多个consumer，利用zero-copy技术，数据只需要拷贝到页面缓存中
一次，并且对于多个网络输出进行复用，因此速度基本可达网络硬件的上限。</p>

<h3>端到端的压缩</h3>

<p>某些时候，系统瓶颈不再于cpu而是网络能力。而由用户简单的将消息压缩后传送给
消息系统无法降低消息间的冗余，更有效的消息压缩应该是将一组消息进行压缩后传输，
更理想的是端到端的方式，数据传输前被压缩后通过producer传输给server，server
不解压直接传送给cosumer，然后由consumer进行解压。</p>

<p>kafka支持递归的消息集合。一组消息被打包后传输给server，然后这组消息被传输给
所有的consumer进行解压后处理。</p>

<h3>消费者状态</h3>

<h3>分布式</h3>

<h3>生产者</h3>

<h3>支持hadoop和其他数据载入</h3>

<h2>实现细节</h2>

<h3>API设计</h3>

<h3>网络层设计</h3>

<h3>消息设计及格式</h3>

<h3>日志</h3>

<h3>分布式</h3>

<h2>#</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/09/slice-reading-0809/">Slice Reading 0809</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T14:23:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/09/slice-reading-0809/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>TimeTunel</h2>

<p>对现有日志的跟踪</p>

<ul>
<li>基于thrift</li>
<li>zookeeper做负载均衡以及分配</li>
<li>环状的broker的repulication</li>
</ul>


<h2>pytailer</h2>

<p><a href="https://github.com/six8/pytailer">pytailer</a></p>

<h2>Durable Event Data Transport at Scale</h2>

<p><a href="http://sharadag.tumblr.com/post/13549427326/durable-event-data-transport-at-scale">link</a></p>

<h2>Twitter Storm Transactional topologies</h2>

<p><a href="https://github.com/nathanmarz/storm/wiki/Transactional-topologies">Transactional topologies</a>
是关于Twitter Storm内部消息持久化的拓扑设计。</p>

<p><a href="http://xumingming.sinaapp.com/109/twitter-storm%E7%AE%80%E4%BB%8B/">chinese intro</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/09/zikpin-intro/">Zikpin Intro</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T11:31:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/09/zikpin-intro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<p>Zipkin是一个分布式的追踪系统，可以通过该系统获取各个服务的时间数据。Twitter用
它来管理信息收集以及查询服务组件。它的思想来源于<a href="http://research.google.com/pubs/pub36356.html">Google Dapper</a></p>

<p>对一个分布式系统进行跟踪监控的原因在于我们可以获取系统服务的深层次数据，比如
某个服务的响应时间，根据这点可以判断当前分布式系统的性能瓶颈以及其他信息。Zikpin
获取这些信息后通过浏览器显示在web上</p>

<p>其体系结构如下</p>

<p><img src="https://github.com/twitter/zipkin/raw/master/doc/architecture-0.png"></p>

<p>每个被追踪的消息在系统中传送时都带了一个追踪标识，zipkin通过该标识在追踪系统
中标记信息，判断时间。所有带有追踪标识的消息在被服务端传送出去时通过工具库将
该消息传送给zipkin系统。</p>

<p>{ % img https://github.com/twitter/zipkin/raw/master/doc/architecture-1.png % }</p>

<h2>组件</h2>

<p><strong>Finagle</strong></p>

<blockquote><p>这使一个基于JVM的异步网络框架，通过它可以创建异步RPC，任何基于JVM的语言都
可以用它来创建客户端/服务端</p></blockquote>

<p><em>Frinagle</em>在twitter中被广泛使用。可以在其上添加追踪功能，目前客户端和服务端均
支持Trift和HTTP协议，缓存部分只支持Memcache和Redis(So far we have client/server support for Thrift and HTTP as well as client only support for Memcache and Redis.)</p>

<p>初始化一个finagle server并绑定追踪服务</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">ServerBuilder</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="na">codec</span><span class="o">(</span><span class="n">ThriftServerFramedCodec</span><span class="o">())</span>
</span><span class='line'>    <span class="o">.</span><span class="na">bindTo</span><span class="o">(</span><span class="n">serverAddr</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="s">&quot;servicename&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="na">tracerFactory</span><span class="o">(</span><span class="n">ZipkinTracer</span><span class="o">())</span>
</span><span class='line'>        <span class="o">.</span><span class="na">build</span><span class="o">(</span><span class="k">new</span> <span class="n">SomeService</span><span class="o">.</span><span class="na">FinagledService</span><span class="o">(</span><span class="n">queryService</span><span class="o">,</span> <span class="k">new</span> <span class="n">TBinaryProtocol</span><span class="o">.</span><span class="na">Factory</span><span class="o">()))</span>
</span></code></pre></td></tr></table></div></figure>


<p>初始化一个客户端类似上面的操作，一旦指定Zipkin为追踪服务，那么请求在开始和
结束的时候被自动追踪，相应的服务和机器也会被同时记录。</p>

<p>可以自定义添加更多的追踪信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Trace</span><span class="o">.</span><span class="na">record</span><span class="o">(</span><span class="s">&quot;starting that extremely expensive computation&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>除了字符串也可以添加key-value信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">Trace</span><span class="o">.</span><span class="na">recordBinary</span><span class="o">(</span><span class="s">&quot;http.response.code&quot;</span><span class="o">,</span> <span class="s">&quot;500&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Ruby Thrift</strong></p>

<p>利用一个gem追踪请求，可以用里面的RackHandler生成id，并通知追踪系统该id。下面
是一个ruby thrift client的例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">ThriftClient</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SomeService</span><span class="o">::</span><span class="no">Client</span><span class="p">,</span> <span class="s2">&quot;127.0.0.1:1234&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">client_id</span> <span class="o">=</span> <span class="no">FinagleThrift</span><span class="o">::</span><span class="no">ClientId</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;service_example.sample_environment&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">FinagleThrift</span><span class="o">.</span><span class="n">enable_tracing!</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">client_id</span><span class="p">),</span> <span class="s2">&quot;service_name&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Querulous</strong></p>

<p>是一个一个SQL的接口库，基于Scala实现</p>

<p><strong>Cassie</strong></p>

<p>是一个Finagle内部的基于Cassandra client库的实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">cluster</span><span class="o">.</span><span class="na">keyspace</span><span class="o">(</span><span class="n">keyspace</span><span class="o">).</span><span class="na">tracerFactory</span><span class="o">(</span><span class="n">ZipkinTracer</span><span class="o">())</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Transport</strong></p>

<p>利用Scribe作为传输模块，利用该模块可以将服务的追踪信息传输给zipkin和hadoop。</p>

<blockquote><p>Scribe已经停止开发了，是否有替换？</p></blockquote>

<p><strong>Zipkin collector daemon</strong></p>

<p>信息收集器，一旦追踪信息传送到收集器，该模块会判断其有效性，存储并索引它。</p>

<p><strong>Storage</strong></p>

<p>存储模块，现在是利用Cassandra实现。可以选择不同的存储方式</p>

<blockquote><p>比如HBase?</p></blockquote>

<p><strong>Zipkin query daemon</strong></p>

<p>查询模块，通过简单的Trift api查找追踪存储后的信息</p>

<p><strong>UI</strong></p>

<p>显示追踪信息，该模块是一个利用D3的Rails应用</p>

<p>模块间关系如下：</p>

<p><img src="https://github.com/twitter/zipkin/raw/master/doc/modules.png"></p>

<h2>安装配置</h2>

<h3>Cassandra</h3>

<pre><code>利用下面的命令链接当前工程
```bash
bin/cassandra-cli -host localhost -port 9160 -f zipkin-server/src/schema/cassandra-schema.txt
```
</code></pre>

<h3>Zookeeper</h3>

<h3>Scribe</h3>

<pre><code>Scribe配置如下

```xml
&lt;store&gt;
  category=zipkin
    type=network
      remote_host=123.123.123.123
        remote_port=9410
          use_conn_pool=yes
            default_max_msg_before_reconnect=50000
              allowable_delta_before_reconnect=12500
                must_succeed=no
                &lt;/store&gt;
```
</code></pre>

<h3>Zipkin server</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git clone https://github.com/twitter/zipkin.git
</span><span class='line'><span class="nb">cd </span>zipkin
</span><span class='line'>cp zipkin-scribe/config/collector-dev.scala zipkin-scribe/config/collector-prod.scala
</span><span class='line'>cp zipkin-server/config/query-dev.scala zipkin-server/config/query-prod.scala
</span><span class='line'>Modify the configs above as needed. Pay particular attention to ZooKeeper and Cassandra server entries.
</span><span class='line'>bin/sbt update package-dist <span class="o">(</span>This downloads SBT 0.11.2 <span class="k">if </span>it doesn<span class="err">&#39;</span>t already exist<span class="o">)</span>
</span><span class='line'>scp dist/zipkin*.zip <span class="o">[</span>server<span class="o">]</span>
</span><span class='line'>ssh <span class="o">[</span>server<span class="o">]</span>
</span><span class='line'>unzip zipkin*.zip
</span><span class='line'>mkdir -p /var/log/zipkin
</span><span class='line'>zipkin-scribe/scripts/collector.sh -f zipkin-scribe/config/collector-prod.scala
</span><span class='line'>zipkin-server/scripts/query.sh -f zipkin-server/config/query-prod.scala
</span></code></pre></td></tr></table></div></figure>


<h3>Zipkin UI</h3>

<p>是一个标准的Rails 3应用</p>

<ol>
<li>升级Zookeeper server的配置。用来定位查询器</li>
<li>发布到何时的Rail 3 server上</li>
</ol>


<p><strong>zipkin-tracer gem</strong></p>

<p>通过Rack Handler在Rails 应用中添加追踪信息，在 config.ru中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">use</span> <span class="no">ZipkinTracer</span><span class="o">::</span><span class="no">RackHandler</span>
</span><span class='line'>  <span class="n">run</span> <span class="o">&lt;</span><span class="no">YOUR_APPLICATION</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>运行一个简单的Hadoop任务</h2>

<p>如果设置Scribe存储到Hadoop上，会产生一系列难以操作数据的报告。因此，利用一个
<a href="http://github.com/twitter/scalding">Scalding</a>来写Hadoop任务</p>

<ol>
<li><p>要运行hadooop任务，需要生成一个全包含的jar包</p>

<p> <code>
 sbt 'project zipkin-hadoop' compile assemble
</code></p></li>
<li><p>修改scald.rb指向需要运行hadoop任务的机器名</p></li>
<li><p>如果需要，升级scald.rb中的jarfile的版本</p></li>
<li><p>通过scald.rb脚本运行hadoop任务</p>

<p> <code>bash
 ./scald.rb --hdfs com.twitter.zipkin.hadoop.[classname] --date yyyy-mm-ddThh:mm yyyy-mm-ddThh:mm --output [dir]
</code></p></li>
</ol>


<h2>Google论文笔记</h2>

<p><a href="http://research.google.com/pubs/pub36356.html">Google Dapper</a>是google发表于2010年的一篇关于分布式服务监控以及查询的论文</p>

<h3>目的</h3>

<h3>方式</h3>

<h3>跟随者</h3>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/09/interview-100-pro/">Interview 100 Pro</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-09T11:00:00+08:00" pubdate data-updated="true">Aug 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/09/interview-100-pro/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简述</h2>

<p>下面是关于程序员面试100题的相关笔记。不全面但是自己可以供参考</p>

<h2>题目</h2>

<h3>题目1</h3>

<p><em>输入一棵二元查找树,将该二元查找树转换成一个排序的双向链表。要求不能创建任何
新的结点,只调整指针的指向</em></p>

<p><strong>方案1</strong>
先完成左子树的转换，链接中间节点后，再完成右子树的转换，然后链接中间节点和右子树</p>

<p><strong>方案2</strong>
中序遍历</p>

<p><strong>注</strong>
中序遍历的算法</p>

<h3>题目2</h3>

<p><em>定义栈的数据结构,要求添加一个 min 函数,能够得到栈的最小元素。要求函数 min、push 以及
pop 的时间复杂度都是 O(1)</em></p>

<p><strong>解析</strong></p>

<p><strong>方案</strong></p>

<p><strong>注</strong></p>

<h3>题目3</h3>

<p><em>输入一个整形数组,数组里有正数也有负数。数组中连续的一个或多个整数组成一个子数组,每个
子数组都有一个和。求所有子数组的和的最大值。要求时间复杂度为 O(n)</em></p>

<p><strong>解析</strong></p>

<p><strong>方案</strong></p>

<p><strong>注</strong></p>

<h3>题目4</h3>

<h3>题目11</h3>

<p><em>输入一颗二元查找树,将该树转换为它的镜像,即在转换后的二元查找树中,左子树的结点都大于
右子树的结点。用递归和循环两种方法完成树的镜像转换</em></p>

<p><strong>解析</strong></p>

<p>对于递归，类似递归遍历方式，在递归前交换左右子树；至于非递归，可以用循环可以用一个栈
来模拟递归操作。</p>

<h3>题目12</h3>

<p><em>输入一颗二元树,从上往下按层打印树的每个结点,同一层中按照从左往右的顺序打印</em></p>

<p><em>解析</em></p>

<p>就是用队列层次遍历</p>

<h3>题目13</h3>

<p><em>在一个字符串中找到第一个只出现一次的字符。如输入 abaccdeff,则输出 b</em></p>

<p><em>解析</em></p>

<p>简单来说O(n<sup>2)的依次比较。可以用哈希。类似的题目，找出相同的字符，相同字符</sup>
的次数，出现次数最多的字符。在一个巨大的文件内出现次数最多的k个成员等等</p>

<h3>题目14</h3>

<p><em>n 个数字(0,1,&#8230;,n-1)形成一个圆圈,从数字 0 开始,每次从这个圆圈中删除第 m 个数字(第一个
为当前数字本身,第二个为当前数字的下一个数字)
。当一个数字删除后,从被删除数字的下一个继续删除
第 m 个数字。求出在这个圆圈中剩下的最后一个数字</em></p>

<p><em>解析</em></p>

<p>约瑟夫问题，可以直接用stl::list模拟行为，然后直接操作。或者利用推导完成递归公式。</p>

<h3>题目15</h3>

<p>关于类中的深浅拷贝问题，需要自定义拷贝构造函数以及重载等号，另外为了避免指针
被外面别的类删除，可以考虑用引用计数的方式</p>

<h3>题目16</h3>

<p><em>用最快的方法求fibonacci数列的第 n 项</em></p>

<p><em>解析</em></p>

<p>由于递归会重复计算很多次相同的值，那么可以考虑从0到n的计算，这样可以省去重复的
次数，复杂度是o(n)</p>

<p>可以有利用数学归纳发发现log(n)的算法</p>

<h3>题目17</h3>

<p><em>输入一个表示整数的字符串,把该字符串转换成整数并输出。例如输入字符串&#8221;345&#8221;,则输出整数
345</em></p>

<p><em>解析</em></p>

<p>问题不难，在c/c++ java python中都有现成的方法，但是大都不够严谨全面。</p>

<p>可以考虑用一个全局变量来标识是否输入合法，标准c中的atoi就是这样做的。</p>

<h3>题目18</h3>

<p><em>-用两个栈实现队列</em></p>

<p><em>解析</em></p>

<p>一个栈出一个栈入，出栈非空一直出，空则将入栈内的数据导入其中</p>

<p><em>注</em></p>

<p>如何用两个队列实现一个栈，可以考虑n个数先入一个队列，一旦要出的话，将前n-1个都
出队，然后入队进另一个队列。每次操作都如此</p>

<h3>题目19</h3>

<p><em>输入一个链表的头结点,反转该链表,并返回反转后链表的头结点</em></p>

<p>需要保存反转节点的子节点</p>

<h3>题目20</h3>

<p><em>如果字符串一的所有字符按其在字符串中的顺序出现在另外一个字符串二中,则字符串一称之为字
符串二的子串。注意,并不要求子串(字符串一)的字符必须连续出现在字符串二中。请编写一个函数,
输入两个字符串,求它们的最长公共子串,并打印出最长公共子串。
例如:输入两个字符串 BDCABA 和 ABCBDAB,字符串 BCBA 和 BDAB 都是是它们的最长公共子串,则
输出它们的长度 4,并打印任意一个子串</em></p>

<p><em>解析</em></p>

<p>经典的动态规划问题。</p>

<h3>题目 26</h3>

<p><em>输入一个正数 n,输出所有和为 n 连续正数序列</em></p>

<p>类似10题</p>

<h3>27</h3>

<p><em>输入一棵二元树的根结点,求该树的深度。从根结点到叶结点依次经过的结点(含根、叶结点)形成树的一条路径,最长路径的长度为树的深度</em></p>

<p>递归遍历二叉树</p>

<h3>28</h3>

<p>递归的考察</p>

<p>似乎穷举和动态规划的方式</p>

<p>值得深入思考下</p>

<h3>29</h3>

<p><em>输入一个整数数组,调整数组中数字的顺序,使得所有奇数位于数组的前半部分,所有偶数位于数
组的后半部分。要求时间复杂度为 O(n)</em></p>

<p>和快速排序类似，但是这个比较的时候不是比较大小，而是除以2看余数是否为0</p>

<p>值得注意的是结构的安排和算法不同部分的解耦</p>

<h3>30</h3>

<p><em>给出如下 CMyString 的声明,要求为该类型添加赋值运算符函数</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">class</span> <span class="nc">CMyString</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">public</span><span class="o">:</span>
</span><span class='line'>  <span class="n">CMyString</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">pData</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>  <span class="n">CMyString</span><span class="p">(</span><span class="k">const</span> <span class="n">CMyString</span><span class="o">&amp;</span> <span class="n">str</span><span class="p">);</span>
</span><span class='line'>  <span class="o">~</span><span class="n">CMyString</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>  <span class="k">private</span><span class="o">:</span>
</span><span class='line'>  <span class="kt">char</span><span class="o">*</span> <span class="n">m_pData</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>除了需要注意的4点外，能够更好的设计结构，利用析构函数更好</p>

<h3>31</h3>

<p><em>输入一个链表的头结点,从尾到头反过来输出每个结点的值。链表结点定义如下</em></p>

<p>me:顺序访问，然后用个栈</p>

<p>解析:</p>

<p>可以用递归，也是用栈，但是是在函数层次的栈</p>

<h3>32</h3>

<p><em>用 C++设计一个不能被继承的类。</em></p>

<p>me: 固定类大小，静态类？</p>

<p>解析：</p>

<p>构造和析构私有</p>

<p>利用模板和虚继承</p>

<h3>33</h3>

<p><em>给定链表的头指针和一个结点指针,在 O(1)时间删除该结点</em></p>

<p>me:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">phead</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">=</span><span class="n">pdelete</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'><span class="n">ptr</span> <span class="o">=</span> <span class="n">phead</span><span class="p">;</span>
</span><span class='line'><span class="n">phead</span><span class="o">=</span><span class="n">phead</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="k">delete</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>解析：</p>

<p>们需要需要把给定的结点的下一个结点的数据拷
贝到给定的结点中</p>

<h3>34</h3>

<p><em>一个整型数组里除了两个数字之外,其他的数字都出现了两次。请写程序找出这两个
只出现一次的数字。要求时间复杂度是 O(n) ,空间复杂度是 O(1)</em></p>

<p>me: 类似bit排序，扫描放入，但是空间复杂度是o(n)</p>

<p>解析：</p>

<p>如果一个数组中只有一个出现一次，其他出现两次，连续异或后只剩下出现一次的数字</p>

<p>(me: 首先连续异或，然后用异或后的数字分别异或所有的值能够出现在数组内的两个值就是)</p>

<p>我们在结果数字中找到第一个为 1 的位的位置,记为第 N 位。现在我们以第
N 位是不是 1 为标准把原数组中的数字分成两个子数组,第一个子数组中每个数字的第 N
位都为 1,而第二个子数组的每个数字的第 N 位都为 0</p>

<h3>35</h3>

<p><em>两个单向链表,找出它们的第一个公共结点</em></p>

<p>me: 组成两个环，一个每次步进1，一个每次步进2，相遇的那一点</p>

<p>可能会遇到后面的公共点</p>

<p>解析：</p>

<p>我们先要分别遍历两个链表得到它们的长度,并求出两个长度之差。在长的
链表上先遍历若干次之后,再同步遍历两个链表,知道找到相同的结点</p>

<h2>#</h2>

<h2>参考</h2>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/08/mongodbquan-wei-zhi-nan-notes/">Mongodb权威指南 Notes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-08T14:42:00+08:00" pubdate data-updated="true">Aug 8<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/08/mongodbquan-wei-zhi-nan-notes/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>入门</h2>

<ul>
<li>文档是数据的基本单元</li>
<li>具有javascript shell</li>
<li>单个实例可以容纳多个独立数据库</li>
</ul>


<h3>文档</h3>

<p>javascript中文档表现为对象</p>

<p>区分类型且区分大小写</p>

<p>文档中不能有重复的键</p>

<h3>集合</h3>

<p>集合就是一组文档。</p>

<p>集合是无模式的</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/08/08/mongodb-simple/">MongoDB Simple</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-08T14:23:00+08:00" pubdate data-updated="true">Aug 8<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/08/08/mongodb-simple/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>简介</h2>

<ul>
<li><p>拓展了关系数据库的功能，比如辅助索引，范围查询以及排序</p></li>
<li><p>内置MapReduce的支持</p></li>
<li><p>文档丰富，接口友好</p></li>
<li><p>MongoDB是一个面向文档的数据库。</p></li>
<li><p>没有模式</p></li>
<li><p>易于扩展</p></li>
<li><p>速度快</p></li>
<li><p>管理方便</p></li>
</ul>


<h2>简单安装和运行</h2>

<ol>
<li>直接下载二进制包</li>
<li>在根目录创建/data/db/目录</li>
<li>运行bin/mongod</li>
</ol>


<p>on Ubuntu</p>

<p>设置GPG key</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
</span></code></pre></td></tr></table></div></figure>


<p>在/etc/apt/sources.list.d/中创建10gen.list添加如下行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen
</span></code></pre></td></tr></table></div></figure>


<p>然后运行</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>sudo apt-get update
</span><span class='line'>sudo apt-get install mongodb-10gen
</span></code></pre></td></tr></table></div></figure>


<h2>设置</h2>

<p>配置文件在/etc/mongodb.conf</p>

<h2>教程</h2>

<p>在其官方网站<a href="http://www.mongodb.org/">Mongodb</a>上有一个Try it out的教程</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/4/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/2/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2012/12/10/install-hadoop-on-ubuntu/">Install Hadoop on Ubuntu</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/15/c10k-xiang-guan/">C10k 相关</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/14/nginx-can-kao/">Nginx 参考</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/13/linuxyi-bu-he-fei-zu-sai/">linux异步和非阻塞</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/11/08/nutch-an-zhuang/">Nutch 安装</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - windfire.cd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'windfire-cd-comments';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
